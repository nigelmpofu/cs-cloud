{% extends "cloud/base.html" %}
{% load staticfiles %}
{% load mathfilters %}
{% block extrahead %}
	<title>User Admin - CS Cloud</title>
	<style>
	a {
		font-family: sans-serif;
		color: #303030
	}
	p {
		padding-left: 5px;
		font-size: 16pt
	}
	.accordion .card-header:after {
		font-family: 'FontAwesome';
		font-size: 17pt;
		content: "\f068";
		float:right
	}
	.accordion .card-header.collapsed:after {
		content: "\f067"
	}
</style>
{% endblock extrahead %}
{% block context %}
<div class="container">
	<div class="shadow p-4 mb-4 bg-white">
		{% if messages %}
		{% for message in messages %}
		<div class="alert alert-{{ message.tags }}"><strong>{{ message|safe }}</strong></div>
		<hr class="my-4">
		{% endfor %}
		{% endif %}
		<div id="accordion" class="accordion">
			<div class="card mb-0">
				<div class="card-header collapsed" data-toggle="collapse" href="#collapseOne">
					<a class="card-title">
						<p style="font-family: arial; font-size: 19pt; display: inline;" align="center">User Registration</p>
					</a>
				</div>
				<div id="collapseOne" class="collapse collapse" data-parent="#accordion">
					<div class="card-body">
						<form action="{% url 'submitUser' %}" method="post" onsubmit="return validateUserForm();" class="form-horizontal user-form" id="userForm" role="form">
							{% csrf_token %}
							{{ userForm }}
							<label id="availStat-{{ userForm.user_id.html_name }}" hidden>unknown</label><br/>
							<label id="availStat-{{ userForm.email.html_name }}" hidden>unknown</label><br/>
							<div class="form-group">
								<!-- Submit Button -->
								<div class="col-sm-offset-2 col-sm-10">
									<button type="submit" class="save btn btn-primary" id="submitUser">Create User Account</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- Maintain Users -->
		<div id="accordion2" class="accordion">
			<div class="card mb-0">
				<div class="card-header collapsed" data-toggle="collapse" href="#collapseTwo">
					<a class="card-title">
						<p style="font-family: arial; font-size: 19pt; display: inline;" align="center">Maintain Users</p>
					</a>
				</div>
				<div id="collapseTwo" class="collapse collapse" data-parent="#accordion2">
					<div class="card-body">													
						<table id='users' class="table table-striped table-bordered">
							<thead>
								<tr>
									<th>Username</th>
									<th>Title</th>
									<th>Initials</th>									
									<th style="display: none;">First Name</th>									
									<th>Surname</th>									
									<th>Email</th>
									<th style="display: none;">Cellphone</th>
									<th>Admin Account</th>
									<th>Disk Quota (MiB)</th>
									<th style="display: none;">Disk Quota</th>
									<th>Edit</th>
									<th>Delete</th>
									<th><i class="fa fa-trash-o" data-toggle="tooltip" title="Multiple Delete"></i></th>
								</tr>
							</thead>
							<tbody>
								{% for user in users %}
								<tr id="user{{ user.pk }}">
									<td data-id="user_id">{{ user.user_id }}</td>
									<td data-id="title">{{ user.title }}</td>
									<td data-id="initials" >{{ user.initials }}</td>									
									<td data-id="fname" style="display: none;">{{ user.name }}</td>									
									<td data-id="surname">{{ user.surname }}</td>								
									<td data-id="email">{{ user.email }}</td>
									<td data-id="cell" style="display: none;">{{ user.cell }}</td>
									<td data-id="acc_type">{{ user.is_staff }}</td>
									<td data-id="spaceUsed">{{ user.used_quota|div:1048576 }}/{{ user.disk_quota|div:1048576 }}</td>
									<td data-id="quota" style="display: none;">{{ user.disk_quota|div:1048576 }}</td>
									<td>
										<button type="button" name="edit" class='btn btn-primary btn-xs edit'
												data-toggle="modal" data-target="#editModal"
												data-csrf='{{ csrf_token }}' data-id="{{ user.user_id }}"
												data-pk="{{ user.pk }}"><i class="fa fa-pencil" style="color: white; font-size: 16pt;" data-toggle="tooltip" title="Edit {{ user.user_id }}"></i></button>
									</td>
									<td>
										<a type="button" class="btn btn-danger btn-xs" href="/userAdmin/userProfile/{{ user.pk }}"><i class="fa fa-trash-o" style="color: whire; font-size: 16pt;" data-toggle="tooltip" title="Delete {{ user.user_id }}?"></i></a>
									</td>
									<td>
										<input type="checkbox" class="multiRemove" data-id="{{ user.user_id }}"
											   data-pk="{{ user.pk }}" data-toggle="tooltip" title="Delete {{ user.user_id }}?">
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table><br/>
						<button type="button" name="remove" id="remove" class='btn btn-warning pull-left' data-csrf="{{csrf_token}}"
								data-id="{{ user.user_id }}" data-pk="{{ user.pk }}">Delete Users</button>						
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% include "cloud/userEditModal.html" %}
<script src="{% static '/js/validation.js' %}"></script>
<script type="text/javascript">
	/*
	Function to check if the entered username and email are available for use
	*/
	function checkUser() {
		checkAvail("{{ userForm.user_id.html_name }}");
	}

	function checkEmail() {
		checkAvail("{{ userForm.email.html_name }}");
	}
	function resetUser() {
		resetField("{{ userForm.user_id.html_name }}");
	}
	function resetEmail() {
		resetField("{{ userForm.email.html_name }}");
	}
	function resetField(id) {
		$("#" + id).removeAttr("style");
		$("#" + id).removeAttr("data-toggle");
		$("#" + id).removeAttr("title");
		$("#availStat-" + id).text("unknown");
	}
	function checkAvail(id) {
		if(!$.trim($("#" + id).val()).length) {
			return; // Textbox blank
		}

		$.ajax({
			url: "{% url 'checkUser' %}",
			type: "POST",
			async: true,
			data: {'data': id == "{{ userForm.user_id.html_name }}" ? "ui" : "em", 'query': $.trim($("#" + id).val()),
				'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').prop('value')},
			dataType: "json",
			success: function (data) {
				if (data.result === 0) { // Available
					$("#" + id).attr("style", "background-color: #387C44; color: white");
					$("#" + id).attr("data-toggle", "tooltip");
					$("#" + id).attr("title", "Available");
					$("#availStat-" + id).text("true");								
				} else {
					$("#" + id).attr("style", "background-color: #C04000; color: white");
					$("#" + id).attr("data-toggle", "tooltip");
					$("#" + id).attr("title", "Already in use");
					$("#availStat-" + id).text("false");
				}
			},
			failure: function () {
				$("#availStat-" + id).text("fail");
			},
			error: function () {
				$("#availStat-" + id).text("error");
			},
			timeout: 3000 // 3 Second timeout
		});
	}
	$(document).ready(function() {
		$('[data-toggle="tooltip"]').tooltip();
		const table = $("#users").DataTable({
			"columns": [
				{ "orderable": true, "searchable": true },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": true },
				{ "orderable": false, "searchable": true },
				{ "orderable": true, "searchable": true },
				{ "orderable": false, "searchable": true },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false },
				{ "orderable": false, "searchable": false }
			  ],
			"initComplete": function () {
				// Hook update user buttons
				editUserHookUpdateButtons(this.api().rows().nodes().toJQuery());
			}			
		});
		$(".btn.more").on("click", function () {
			var pk = $(this).data("pk");
			window.location.href = "" + pk;
		});
	});
	$("#updateEmailConfirm").on("click", function() {
		var emailText = $("#emailText").val();
		var token = $(this).data("csrf");
		var data = {
			'emailText': emailText,
			'csrfmiddlewaretoken': token
		};
		$.ajax({
			type: 'POST',
			url: '/userAdmin/updateEmail/',
			data: data,
			success: function() {
				alert("Updated");
			}
		});
	});
	$("#remove").on("click", function () {
		var toDelete = [];
		var token = $(this).data("csrf");
		$("input:checked.multiRemove").each(function() {
			if (this.checked) {
				toDelete.push({
					"id": $(this).data("id"),
					"pk": $(this).data("pk")
				});
			}
		});
		var toDeleteMessage = "Are you sure you want to delete these users:\n";
		var toDeleteList = [];
		$.each(toDelete, function(index, value) {
			toDeleteMessage += value.id + "\n";
			toDeleteList.push(value.pk);
		});
		if(confirm(toDeleteMessage)) {
			var data = {
				'toDelete': toDeleteList,
				'csrfmiddlewaretoken': token
			};
			$.ajax({
				type: 'POST',
				url: '/userAdmin/delete/',
				data: data,
				success: function() {
					$.each(toDeleteList, function(index, value) {
						$("#users > tbody > tr#" + value).fadeOut(500);
					});
				}
			});
		}
	});
</script>
{% endblock context %}